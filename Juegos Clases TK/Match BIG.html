<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Match Master - BIG</title>

    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Nunito', sans-serif;
            -ms-overflow-style: none;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
            overscroll-behavior: none;
            user-select: none;
            background: #fdf4ff;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }

        .pt-safe {
            padding-top: var(--safe-top);
        }

        .pb-safe {
            padding-bottom: var(--safe-bottom);
        }

        .min-h-screen-safe {
            min-height: 100dvh;
        }

        /* Draggable styles */
        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            cursor: grabbing;
        }

        .drop-target-active {
            border-color: #a855f7 !important;
            background-color: rgba(168, 85, 247, 0.05) !important;
            transform: scale(1.02);
        }

        .matched-item {
            opacity: 0.4;
            pointer-events: none;
        }

        .gradient-text {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen-safe w-full">

    <div id="root" class="h-full w-full">
        <div class="flex h-full w-full items-center justify-center bg-slate-50 text-fuchsia-600">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-current"></div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const SUPABASE_URL = "https://qbuoonnwtkjitfyzeufc.supabase.co";
        const SUPABASE_KEY = "sb_publishable_6MQUgygham4m6ko_Yo244w_z0xBNcRW";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const GAME_TYPE = "match";
        const GAME_VERSION = "BIG";
        const STORAGE_BUCKET = "game-assets";

        const Icons = {
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg>,
            Volume: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>,
            Home: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>,
            X: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Grid: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Settings: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Trash: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            Loader: ({ className }) => <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>,
            Ear: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 13V7a6 6 0 1 1 12 0v6"></path><path d="M6 13a3 3 0 0 0 6 0"></path><path d="M18 13a3 3 0 0 1-6 0"></path><path d="M12 22h.01"></path></svg>,
            Type: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
        };

        const shuffle = (array) => [...array].sort(() => Math.random() - 0.5);

        const AdminPanel = ({ isOpen, onClose, data, onRefresh, session }) => {
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPassword, setLoginPassword] = useState("");
            const [isUploading, setIsUploading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                const { error } = await supabaseClient.auth.signInWithPassword({
                    email: loginEmail,
                    password: loginPassword,
                });
                if (error) alert("Error: " + error.message);
            };
            const handleFileUpload = async (e) => {
                const files = e.target.files; if (!files || files.length === 0) return; setIsUploading(true);
                try {
                    for (const file of files) {
                        const fileName = file.name; const cleanName = fileName.split('.')[0].replace(/_/g, ' ').toUpperCase();
                        const fileExt = fileName.split('.').pop(); const path = `${GAME_TYPE}/${GAME_VERSION}/${Date.now()}_${fileName}`;
                        const isAudio = ['mp3', 'wav', 'm4a'].includes(fileExt.toLowerCase());

                        const { data: existing } = await supabaseClient.from('game_content').select('*').eq('game_type', GAME_TYPE).eq('version', GAME_VERSION).eq('text', cleanName).single();

                        if (existing) {
                            const oldUrl = isAudio ? existing.audio_url : existing.image_url;
                            if (oldUrl) {
                                const oldPath = oldUrl.split(`${STORAGE_BUCKET}/`)[1];
                                if (oldPath) await supabaseClient.storage.from(STORAGE_BUCKET).remove([oldPath]);
                            }
                        }

                        const { data: uploadData, error: uploadError } = await supabaseClient.storage.from(STORAGE_BUCKET).upload(path, file); if (uploadError) throw uploadError;
                        const { data: { publicUrl } } = supabaseClient.storage.from(STORAGE_BUCKET).getPublicUrl(path);

                        if (existing) await supabaseClient.from('game_content').update({ [isAudio ? 'audio_url' : 'image_url']: publicUrl }).eq('id', existing.id);
                        else await supabaseClient.from('game_content').insert([{ game_type: GAME_TYPE, version: GAME_VERSION, text: cleanName, [isAudio ? 'audio_url' : 'image_url']: publicUrl }]);
                    }
                    alert("Carga completada"); onRefresh();
                } catch (err) { alert("Error: " + err.message); } finally { setIsUploading(false); }
            };
            const handleDelete = async (item) => {
                if (!confirm(`¬øEliminar ${item.text}?`)) return;
                try {
                    const filesToRemove = [];
                    if (item.image_url) {
                        const imgPath = item.image_url.split(`${STORAGE_BUCKET}/`)[1];
                        if (imgPath) filesToRemove.push(imgPath);
                    }
                    if (item.audio_url) {
                        const audPath = item.audio_url.split(`${STORAGE_BUCKET}/`)[1];
                        if (audPath) filesToRemove.push(audPath);
                    }
                    if (filesToRemove.length > 0) {
                        await supabaseClient.storage.from(STORAGE_BUCKET).remove(filesToRemove);
                    }
                    await supabaseClient.from('game_content').delete().eq('id', item.id);
                    onRefresh();
                } catch (err) { alert("Error al eliminar: " + err.message); }
            };

            const handleDeleteAll = async () => {
                if (!confirm("‚ö†Ô∏è ¬øBORRAR TODO? Esta acci√≥n no se puede deshacer.")) return;
                try {
                    const { data: files } = await supabaseClient.storage.from(STORAGE_BUCKET).list(`${GAME_TYPE}/${GAME_VERSION}`);
                    if (files && files.length > 0) {
                        const paths = files.map(f => `${GAME_TYPE}/${GAME_VERSION}/${f.name}`);
                        await supabaseClient.storage.from(STORAGE_BUCKET).remove(paths);
                    }
                    await supabaseClient.from('game_content').delete().eq('game_type', GAME_TYPE).eq('version', GAME_VERSION);
                    alert("Todos los datos han sido borrados.");
                    onRefresh();
                } catch (err) { alert("Error al borrar todo: " + err.message); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-3xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden shadow-2xl">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50"><h2 className="font-black text-slate-700 uppercase">Match Admin</h2><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icons.X className="w-5 h-5" /></button></div>
                        {!session ? (
                            <form onSubmit={handleLogin} className="p-8 flex flex-col items-center gap-4">
                                <p className="font-bold text-slate-500">Acceso Administrador</p>
                                <input type="email" placeholder="Email" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} className="border-2 border-slate-200 rounded-xl px-4 py-2 w-full max-w-xs focus:border-indigo-400 outline-none" />
                                <input type="password" placeholder="Password" value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)} className="border-2 border-slate-200 rounded-xl px-4 py-2 w-full max-w-xs focus:border-indigo-400 outline-none" />
                                <button type="submit" className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">ENTRAR</button>
                            </form>
                        ) : (
                            <div className="flex-1 overflow-y-auto p-4 no-scrollbar">
                                <div className="flex justify-between items-center mb-4 px-2">
                                    <span className="text-[10px] font-black text-emerald-500 uppercase tracking-widest flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Sesi√≥n Activa: {session.user.email}</span>
                                    <button onClick={() => supabaseClient.auth.signOut()} className="text-[10px] font-black text-slate-400 hover:text-red-500 uppercase tracking-widest transition-colors">Cerrar Sesi√≥n</button>
                                </div>
                                <div className="flex gap-2 mb-6">
                                    <label className="flex-1 border-2 border-dashed border-purple-200 rounded-2xl p-6 text-center cursor-pointer hover:bg-purple-50 transition-colors">
                                        <input type="file" multiple onChange={handleFileUpload} className="hidden" accept="image/*,audio/*" />
                                        {isUploading ? <Icons.Loader className="mx-auto w-8 h-8 text-purple-600" /> : <div className="text-purple-600 font-bold">+ CARGAR ARCHIVOS</div>}
                                    </label>
                                    <button onClick={handleDeleteAll} className="bg-red-50 text-red-500 p-4 rounded-2xl hover:bg-red-100 flex items-center justify-center transition-colors border border-red-100" title="BORRAR TODO">
                                        <Icons.Trash className="w-6 h-6" />
                                    </button>
                                </div>
                                <div className="space-y-2">{data.map(item => (<div key={item.id} className="flex items-center gap-3 bg-slate-50 p-3 rounded-2xl border border-slate-100"><div className="w-12 h-12 bg-white rounded-lg overflow-hidden flex-shrink-0">{item.image_url && <img src={item.image_url} className="w-full h-full object-contain p-1" />}</div><div className="flex-1 min-w-0"><p className="font-bold text-sm truncate">{item.text}</p><div className="flex gap-2"><span className={`text-[10px] ${item.image_url ? 'text-green-500 font-bold' : 'text-slate-300'}`}>IMG</span><span className={`text-[10px] ${item.audio_url ? 'text-green-500 font-bold' : 'text-slate-300'}`}>AUD</span></div></div><button onClick={() => handleDelete(item)} className="p-2 text-red-400 hover:bg-red-50 rounded-full"><Icons.Trash className="w-4 h-4" /></button></div>))}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MenuScreen = ({ onStart, onAdmin }) => (
            <div className="flex flex-col items-center justify-center h-full p-4 animate-pop-in pt-safe pb-safe">
                <button onClick={onAdmin} className="absolute top-4 right-4 p-3 text-slate-300 hover:text-slate-500 pt-safe transition-colors"><Icons.Settings className="w-6 h-6" /></button>
                <div className="glass-card p-8 rounded-[3rem] shadow-xl text-center max-w-md w-full relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 via-fuchsia-500 to-pink-500"></div>
                    <h1 className="text-3xl md:text-4xl font-black text-slate-800 mb-2 tracking-tight uppercase leading-tight mt-4">MATCH MASTER</h1>
                    <p className="text-slate-500 font-bold mb-8 text-base">Drag the image to its pair!</p>

                    <div className="grid grid-cols-1 gap-4">
                        <button onClick={() => onStart('word')} className="w-full bg-white text-slate-700 border-2 border-slate-100 font-black py-4 px-2 rounded-2xl shadow-sm transform transition-all active:scale-95 flex items-center justify-center gap-3 hover:bg-fuchsia-50 hover:border-fuchsia-200 group">
                            <Icons.Type className="w-6 h-6 text-fuchsia-500 group-hover:scale-110 transition-transform" /> IMAGE ‚ûî WORD
                        </button>
                        <button onClick={() => onStart('sound')} className="w-full bg-white text-slate-700 border-2 border-slate-100 font-black py-4 px-2 rounded-2xl shadow-sm transform transition-all active:scale-95 flex items-center justify-center gap-3 hover:bg-purple-50 hover:border-purple-200 group">
                            <Icons.Ear className="w-6 h-6 text-purple-500 group-hover:scale-110 transition-transform" /> IMAGE ‚ûî SOUND
                        </button>
                    </div>
                </div>
            </div>
        );

        const GameScreen = ({ mode, data, onExit, onFinish }) => {
            const TOTAL_STAGES = 5;
            const ITEMS_PER_STAGE = 4;
            const [currentStage, setCurrentStage] = useState(0);
            const [allStages, setAllStages] = useState([]);
            const [sources, setSources] = useState([]);
            const [targets, setTargets] = useState([]);
            const [matches, setMatches] = useState({}); // { sourceId: targetId }
            const [draggingId, setDraggingId] = useState(null);
            const [selectedSourceId, setSelectedSourceId] = useState(null);
            const [dragOverId, setDragOverId] = useState(null);
            const [timer, setTimer] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => setTimer(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (data.length === 0) return;

                const stages = [];
                for (let i = 0; i < TOTAL_STAGES; i++) {
                    if (mode === 'word') {
                        let stageData = [];
                        let pool = shuffle([...data]);
                        while (stageData.length < ITEMS_PER_STAGE) {
                            if (pool.length === 0) pool = shuffle([...data]);
                            const item = pool.pop();
                            if (!stageData.find(x => x.id === item.id)) stageData.push(item);
                        }
                        stages.push({
                            sources: shuffle(stageData),
                            targets: shuffle(stageData)
                        });
                    } else {
                        const target = data[i % data.length];
                        let distractors = [];
                        let pool = shuffle(data.filter(x => x.id !== target.id));
                        while (distractors.length < 3) {
                            if (pool.length === 0) pool = [target]; // Should not happen if data.length > 1
                            distractors.push(pool.pop());
                            if (pool.length === 0 && distractors.length < 3) pool = shuffle(data.filter(x => x.id !== target.id));
                        }
                        const options = shuffle([target, ...distractors.slice(0, 3)]);
                        stages.push({
                            sources: options,
                            targets: [target]
                        });
                    }
                }
                setAllStages(stages);
                setSources(stages[0].sources);
                setTargets(stages[0].targets);
                setCurrentStage(0);
                setMatches({});
            }, [data, mode]);

            const playAudio = (url) => { if (url) new Audio(url).play().catch(() => { }); };

            useEffect(() => {
                if (allStages.length > 0 && mode === 'sound' && currentStage < TOTAL_STAGES) {
                    const currentTarget = allStages[currentStage].targets[0];
                    if (currentTarget && currentTarget.audio_url) {
                        const timeout = setTimeout(() => playAudio(currentTarget.audio_url), 800);
                        return () => clearTimeout(timeout);
                    }
                }
            }, [currentStage, allStages, mode]);

            const onDragStart = (id) => {
                setDraggingId(id);
            };

            const onDragOver = (e, id) => {
                e.preventDefault();
                setDragOverId(id);
            };

            const onDrop = (targetId) => {
                const sourceId = draggingId;
                onDropWithSource(sourceId, targetId);
            };

            const handleSourceClick = (id) => {
                if (matches[id]) return;
                setSelectedSourceId(selectedSourceId === id ? null : id);
            };

            const handleTargetClick = (id) => {
                if (selectedSourceId) {
                    onDropWithSource(selectedSourceId, id);
                }
            };

            const onDropWithSource = (sourceId, targetId) => {
                setDraggingId(null);
                setDragOverId(null);

                if (!sourceId) return;

                if (sourceId === targetId) {
                    // Correct Match
                    const newMatches = { ...matches, [sourceId]: targetId };
                    setMatches(newMatches);
                    setSelectedSourceId(null);
                    new Audio('https://static.wixstatic.com/mp3/8985b1_77a6414de64642bc929559dfa233cef2.wav').play().catch(() => { });

                    const sourceItem = sources.find(s => s.id === sourceId);
                    if (mode === 'sound' && sourceItem.audio_url) playAudio(sourceItem.audio_url);

                    // Check if Finished Stage
                    if (Object.keys(newMatches).length === targets.length) {
                        setTimeout(() => {
                            if (currentStage + 1 < TOTAL_STAGES) {
                                const nextIndex = currentStage + 1;
                                setCurrentStage(nextIndex);
                                setSources(allStages[nextIndex].sources);
                                setTargets(allStages[nextIndex].targets);
                                setMatches({});
                                setDraggingId(null);
                                setDragOverId(null);
                                setSelectedSourceId(null);
                            } else {
                                onFinish({ time: timer });
                            }
                        }, 1000);
                    }
                } else {
                    // Wrong Match
                    setSelectedSourceId(null);
                    new Audio('https://static.wixstatic.com/mp3/8985b1_ec1fb38bd5694e8791066c2ad23f0abf.wav').play().catch(() => { });
                }
            };

            if (sources.length === 0) return null;

            return (
                <div className="h-full flex flex-col w-full max-w-6xl mx-auto pt-safe pb-safe px-safe overflow-hidden">
                    <div className="px-6 py-4 flex justify-between items-center bg-white/50 backdrop-blur-sm z-20">
                        <button onClick={onExit} className="p-3 bg-white rounded-2xl text-slate-400 border shadow-sm active:scale-95"><Icons.Home className="w-6 h-6" /></button>
                        <div className="flex flex-col items-center flex-1 px-4">
                            <div className="font-black text-fuchsia-600 text-[10px] md:text-sm tracking-widest uppercase text-center line-clamp-1">STAGE {currentStage + 1} / {TOTAL_STAGES}</div>
                            <div className="font-bold text-slate-400 text-[8px] md:text-[10px] uppercase tracking-tighter text-center line-clamp-1">{mode === 'word' ? 'Link the Image to the Word' : 'Link the Image to the Sound'}</div>
                            <div className="h-1.5 w-32 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                <div className="h-full bg-gradient-to-r from-purple-500 to-fuchsia-500 transition-all duration-500" style={{ width: `${((currentStage + (Object.keys(matches).length / targets.length)) / TOTAL_STAGES) * 100}%` }}></div>
                            </div>
                        </div>
                        <div className="px-4 py-2 bg-slate-800 text-white rounded-2xl font-black shadow-lg text-sm tabular-nums">{Math.floor(timer / 60)}:{String(timer % 60).padStart(2, '0')}</div>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row gap-4 p-4 min-h-0">
                        {/* Column 1: Images */}
                        <div className="flex-1 overflow-y-auto no-scrollbar bg-white/30 rounded-[2.5rem] p-4 border border-white/50 shadow-inner">
                            <h3 className="text-center font-black text-slate-400 text-sm uppercase mb-4 tracking-widest">Images</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 gap-4">
                                {sources.map(item => (
                                    <div
                                        key={item.id}
                                        draggable={!matches[item.id]}
                                        onDragStart={() => onDragStart(item.id)}
                                        onClick={() => handleSourceClick(item.id)}
                                        className={`aspect-square bg-white rounded-3xl p-3 shadow-sm border-2 transition-all cursor-grab active:cursor-grabbing flex items-center justify-center relative group
                                            ${draggingId === item.id ? 'dragging scale-90' : 'hover:border-purple-200 hover:shadow-md'}
                                            ${selectedSourceId === item.id ? 'border-purple-500 ring-4 ring-purple-100 scale-105' : 'border-transparent'}
                                            ${matches[item.id] ? 'matched-item grayscale ring-4 ring-green-100' : ''}
                                        `}
                                    >
                                        <img src={item.image_url} className="w-full h-full object-contain pointer-events-none" />
                                        {matches[item.id] && <div className="absolute inset-0 flex items-center justify-center bg-green-500/10 rounded-3xl"><div className="bg-white p-2 rounded-full text-green-500 shadow-lg"><Icons.Refresh className="w-4 h-4 rotate-45" /></div></div>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Column 2: Targets */}
                        <div className="flex-1 overflow-y-auto no-scrollbar bg-white/30 rounded-[2.5rem] p-4 border border-white/50 shadow-inner">
                            <h3 className="text-center font-black text-slate-400 text-sm uppercase mb-4 tracking-widest">{mode === 'word' ? 'Words' : 'Sounds'}</h3>
                            <div className={`${mode === 'word' ? 'grid grid-cols-2' : 'flex flex-col'} gap-4`}>
                                {targets.map(item => {
                                    const isMatched = Object.values(matches).includes(item.id);
                                    return (
                                        <div
                                            key={item.id}
                                            onDragOver={(e) => onDragOver(e, item.id)}
                                            onDragLeave={() => setDragOverId(null)}
                                            onDrop={() => onDrop(item.id)}
                                            onClick={() => handleTargetClick(item.id)}
                                            className={`min-h-[80px] md:min-h-[100px] w-full bg-white rounded-3xl p-4 flex items-center justify-center text-center transition-all border-4 border-dashed cursor-pointer
                                                ${dragOverId === item.id || (selectedSourceId && !isMatched) ? 'drop-target-active' : 'border-slate-100'}
                                                ${isMatched ? 'border-solid border-green-400 bg-green-50 ring-8 ring-green-100' : ''}
                                            `}
                                        >
                                            {isMatched ? (
                                                <div className="flex flex-col items-center gap-0.5 animate-pop-in">
                                                    <div className="font-black text-green-600 uppercase text-lg line-clamp-1 leading-tight">{item.text}</div>
                                                    <div className="text-[10px] font-black text-green-400 tracking-widest uppercase">MATCHED!</div>
                                                </div>
                                            ) : (
                                                mode === 'word' ? (
                                                    <div className="text-sm md:text-xl font-black text-slate-700 uppercase tracking-wide group-hover:scale-110 transition-transform">{item.text}</div>
                                                ) : (
                                                    <button onClick={() => playAudio(item.audio_url)} className="flex items-center gap-3 bg-purple-100 hover:bg-purple-200 text-purple-600 px-6 py-3 rounded-2xl transition-all active:scale-95 group">
                                                        <Icons.Volume className="w-8 h-8 group-hover:scale-110 transition-transform" />
                                                        <span className="font-black uppercase tracking-wider">TAP AUDIO</span>
                                                    </button>
                                                )
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('menu');
            const [gameMode, setGameMode] = useState('word');
            const [dbData, setDbData] = useState([]);
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [session, setSession] = useState(null);
            const [stats, setStats] = useState({ time: 0 });

            const fetchData = useCallback(async () => {
                const { data } = await supabaseClient.from('game_content').select('*').eq('game_type', GAME_TYPE).eq('version', GAME_VERSION).order('created_at', { ascending: false });
                if (data) setDbData(data);
            }, []);

            useEffect(() => {
                fetchData();
                supabaseClient.auth.getSession().then(({ data: { session } }) => setSession(session));
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => setSession(session));
                return () => subscription.unsubscribe();
            }, [fetchData]);

            return (
                <div className="w-full min-h-screen-safe bg-gradient-to-br from-fuchsia-100 via-purple-50 to-indigo-100 relative">
                    {view === 'menu' && <MenuScreen onStart={(m) => { setGameMode(m); setView('game'); }} onAdmin={() => setIsAdminOpen(true)} />}
                    {view === 'game' && <GameScreen mode={gameMode} data={dbData} onExit={() => setView('menu')} onFinish={(s) => { setStats(s); setView('result'); }} />}
                    {view === 'result' && (
                        <div className="h-full flex flex-col items-center justify-center p-6 animate-pop-in mt-safe">
                            <div className="glass-card rounded-[4rem] shadow-2xl p-10 max-w-sm w-full text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-500"></div>
                                <div className="text-6xl mb-4">üèÜ</div>
                                <h2 className="text-4xl font-black text-slate-800 mb-2 italic">WINNER!</h2>
                                <p className="text-slate-500 font-bold mb-8 uppercase tracking-widest text-sm">Perfect Association</p>
                                <div className="bg-green-50 p-6 rounded-[2rem] border-2 border-green-100 mb-8"><p className="text-green-400 text-xs font-black uppercase mb-1">Final Time</p><p className="text-3xl font-black text-green-700">{Math.floor(stats.time / 60)}:{String(stats.time % 60).padStart(2, '0')}</p></div>
                                <div className="space-y-4">
                                    <button onClick={() => setView('game')} className="w-full bg-slate-800 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3"><Icons.Refresh /> TRY AGAIN</button>
                                    <button onClick={() => setView('menu')} className="w-full bg-white text-slate-500 border-2 border-slate-100 font-black py-4 rounded-2xl active:scale-95 transition-all">BACK TO MENU</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <AdminPanel isOpen={isAdminOpen} onClose={() => setIsAdminOpen(false)} data={dbData} onRefresh={fetchData} session={session} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>