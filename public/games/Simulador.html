<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Game Simulator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .device-frame {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: #1e293b;
            border: 12px solid #334155;
            border-radius: 3rem;
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.5);
        }

        .device-frame::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 25px;
            background: #000;
            border-radius: 20px;
            z-index: 20;
        }

        .landscape {
            transform: rotate(-90deg);
        }

        .landscape iframe {
            transform: rotate(90deg);
            transform-origin: center;
        }

        iframe {
            border: none;
            width: 100%;
            height: 100%;
            border-radius: 2rem;
            background: #fff;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .btn-game {
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-game:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateX(5px);
        }

        .active-game {
            background: rgba(99, 102, 241, 0.3) !important;
            border-color: #6366f1 !important;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .has-data {
            border: 1.5px solid rgba(239, 68, 68, 0.6) !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.15);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-published {
            background: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .status-draft {
            background: #64748b;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = "https://qbuoonnwtkjitfyzeufc.supabase.co";
        const SUPABASE_KEY = "sb_publishable_6MQUgygham4m6ko_Yo244w_z0xBNcRW";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const DEVICES = {
            iphone13: { name: 'iPhone 13', width: 390, height: 844, scale: 0.8 },
            iphone15: { name: 'iPhone 15 Pro', width: 393, height: 852, scale: 0.8 },
            pixel: { name: 'Google Pixel 7', width: 412, height: 915, scale: 0.75 },
            ipad: { name: 'iPad Mini', width: 744, height: 1133, scale: 0.55 }
        };

        const GAMES = [
            { id: 'listen', name: 'Listen', icon: 'ðŸŽ§', color: 'indigo' },
            { id: 'memoria', name: 'Memoria', icon: 'ðŸ§ ', color: 'purple' },
            { id: 'search', name: 'Search', icon: 'ðŸ”', color: 'cyan' },
            { id: 'select', name: 'Select', icon: 'âœ…', color: 'pink' },
            { id: 'pad', name: 'Pad', icon: 'ðŸŽµ', color: 'emerald' },
            { id: 'spell', name: 'Spell', icon: 'ðŸ', color: 'amber' },
            { id: 'match', name: 'Match', icon: 'ðŸ§©', color: 'fuchsia' }
        ];

        const VERSIONS = ['BASE', 'MINI', 'TINY', 'BIG', 'RC'];

        const App = () => {
            const [selectedGame, setSelectedGame] = useState('Listen');
            const [selectedVersion, setSelectedVersion] = useState('BASE');
            const [device, setDevice] = useState('iphone13');
            const [isLandscape, setIsLandscape] = useState(false);
            const [zoom, setZoom] = useState(0.8);
            const [loadedGames, setLoadedGames] = useState(new Set());
            const [publishedGames, setPublishedGames] = useState(new Set());
            const [isPublishing, setIsPublishing] = useState(false);
            const [session, setSession] = useState(null);
            const [loginEmail, setLoginEmail] = useState('');
            const [loginPassword, setLoginPassword] = useState('');

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                const { error } = await supabaseClient.auth.signInWithPassword({
                    email: loginEmail,
                    password: loginPassword,
                });
                if (error) alert("Error: " + error.message);
            };

            const handleLogout = () => supabaseClient.auth.signOut();

            const checkData = async () => {
                try {
                    if (typeof supabase === 'undefined') return;

                    // Check which games have data
                    const { data: contentData } = await supabaseClient
                        .from('game_content')
                        .select('game_type, version');

                    if (contentData) {
                        setLoadedGames(new Set(contentData.map(item => `${item.game_type?.toLowerCase()}-${item.version?.toUpperCase()}`)));
                    }

                    // Check which games are published
                    const { data: statusData } = await supabaseClient
                        .from('game_status')
                        .select('game_id, version, is_published');

                    if (statusData) {
                        const published = new Set(statusData.filter(s => s.is_published).map(s => `${s.game_id?.toLowerCase()}-${s.version?.toLowerCase()}`));
                        setPublishedGames(published);
                    }
                } catch (err) {
                    console.error('Error loading data:', err);
                }
            };

            useEffect(() => {
                const initialTimer = setTimeout(checkData, 1000);
                const interval = setInterval(checkData, 30000);
                return () => { clearTimeout(initialTimer); clearInterval(interval); };
            }, []);

            const togglePublish = async () => {
                if (!session) {
                    alert("Debes iniciar sesiÃ³n para publicar.");
                    return;
                }
                const gameId = selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase();
                const version = selectedVersion.toLowerCase();
                const comboId = `${gameId}-${version}`;
                const isCurrentlyPublished = publishedGames.has(comboId);

                if (isCurrentlyPublished) {
                    if (!confirm(`Â¿Quieres despublicar ${selectedGame} ${selectedVersion}?`)) return;
                    setIsPublishing(true);
                    try {
                        const fileName = `${gameId}-${version}.html`;
                        // Remove from storage to make sure the link stops working
                        await supabaseClient.storage.from('published-games').remove([fileName]);

                        const { error } = await supabaseClient
                            .from('game_status')
                            .update({ is_published: false })
                            .eq('game_id', gameId)
                            .eq('version', version);
                        if (error) throw error;
                        await checkData();
                    } catch (err) { alert(err.message); }
                    finally { setIsPublishing(false); }
                } else {
                    // Try auto-publish first
                    handleAutoPublish();
                }
            };

            const handleAutoPublish = async () => {
                const gameId = selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase();
                const version = selectedVersion.toLowerCase();
                const fileName = `${gameId}-${version}.html`;
                const localPath = getGamePath();

                setIsPublishing(true);
                try {
                    const response = await fetch(localPath);
                    if (!response.ok) throw new Error("No se pudo leer el archivo local automÃ¡ticamente. Por favor, selecciÃ³nalo manualmente.");

                    const blob = await response.blob();
                    const file = new File([blob], fileName, { type: 'text/html' });

                    await uploadGameFile(file, gameId, version);
                    alert('Â¡Juego publicado con Ã©xito desde archivo local!');
                } catch (err) {
                    console.log("Auto-publish failed, falling back to manual:", err.message);
                    document.getElementById('file-upload').click();
                } finally {
                    setIsPublishing(false);
                }
            };

            const uploadGameFile = async (file, gameId, version) => {
                const fileName = `${gameId}-${version}.html`;

                // Limpiar el archivo viejo
                await supabaseClient.storage.from('published-games').remove([fileName]);

                const { error: uploadError } = await supabaseClient.storage
                    .from('published-games')
                    .upload(fileName, file, {
                        upsert: true,
                        contentType: 'text/html',
                        cacheControl: '0'
                    });

                if (uploadError) throw uploadError;

                const { error: dbError } = await supabaseClient
                    .from('game_status')
                    .upsert({
                        game_id: gameId,
                        version: version,
                        is_published: true,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'game_id,version' });

                if (dbError) throw dbError;
                await checkData();
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const gameId = selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase();
                const version = selectedVersion.toLowerCase();

                setIsPublishing(true);
                try {
                    await uploadGameFile(file, gameId, version);
                    alert('Â¡Juego subido y publicado con Ã©xito!');
                } catch (err) {
                    alert('Error al publicar: ' + err.message);
                } finally {
                    setIsPublishing(false);
                    event.target.value = '';
                }
            };

            const copyUrl = () => {
                const gameId = selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase();
                const version = selectedVersion.toLowerCase();
                const url = `https://www.institutotinykids.com/play?game=${gameId}-${version}`;
                navigator.clipboard.writeText(url);
                alert('URL Copiada: ' + url);
            };

            const getGamePath = () => {
                const gameName = selectedGame === 'Pad' ? 'PAD' : selectedGame;
                return `${gameName} ${selectedVersion}.html`;
            };

            const currentDevice = DEVICES[device];

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-80 glass border-r border-white/5 flex flex-col z-30">
                        <div className="p-6 border-b border-white/5">
                            <h1 className="text-2xl font-extrabold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                                TK SIMULATOR
                            </h1>
                            <p className="text-slate-500 text-xs font-bold mt-1 tracking-widest uppercase">Developer Tools</p>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {GAMES.map(game => (
                                <div key={game.id} className="mb-6">
                                    <div className="flex items-center gap-2 mb-3 px-2">
                                        <span className="text-lg">{game.icon}</span>
                                        <h3 className="text-sm font-black text-slate-400 uppercase tracking-wider">{game.name}</h3>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        {VERSIONS.map(v => {
                                            const gameId = game.id.toLowerCase();
                                            const version = v.toLowerCase();
                                            const gameCombo = `${gameId}-${version}`;
                                            const isActive = selectedGame === game.name && selectedVersion === v;
                                            const hasData = loadedGames.has(`${gameId}-${v.toUpperCase()}`);
                                            const isPublished = publishedGames.has(gameCombo);

                                            return (
                                                <button
                                                    key={v}
                                                    onClick={() => { setSelectedGame(game.name); setSelectedVersion(v); }}
                                                    className={`py-2 px-3 rounded-xl text-[10px] font-black transition-all btn-game text-left flex items-center justify-between ${isActive ? 'active-game text-white' : 'bg-white/5 text-slate-400'} ${hasData ? 'has-data' : ''}`}
                                                >
                                                    <span>{v}</span>
                                                    <span className={`status-dot ${isPublished ? 'status-published' : 'status-draft'}`}></span>
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="p-6 border-t border-white/5 bg-black/20">
                            {!session ? (
                                <form onSubmit={handleLogin} className="space-y-3">
                                    <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Admin Access</h4>
                                    <input
                                        type="email" placeholder="Email"
                                        value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)}
                                        className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs focus:border-indigo-500 outline-none"
                                    />
                                    <input
                                        type="password" placeholder="Password"
                                        value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)}
                                        className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs focus:border-indigo-500 outline-none"
                                    />
                                    <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-black py-2 rounded-lg transition-colors">
                                        LOGIN
                                    </button>
                                </form>
                            ) : (
                                <div className="space-y-3">
                                    <div className="flex items-center justify-between">
                                        <div className="flex flex-col">
                                            <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Logged in as</span>
                                            <span className="text-xs font-bold text-emerald-400 truncate max-w-[120px]">{session.user.email}</span>
                                        </div>
                                        <button onClick={handleLogout} className="p-2 hover:bg-white/5 rounded-lg text-slate-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-4 text-xs font-bold text-slate-500 uppercase tracking-tighter">
                                        <span>Status:</span>
                                        <span className="flex items-center gap-1 text-emerald-400">
                                            <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                                            Authenticated
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 relative flex flex-col bg-[#020617]">
                        {/* Toolbar */}
                        <header className="h-16 glass border-b border-white/5 flex items-center justify-between px-8 z-20">
                            <div className="flex items-center gap-6">
                                <div className="flex bg-black/40 p-1 rounded-xl">
                                    {Object.entries(DEVICES).map(([key, d]) => (
                                        <button
                                            key={key}
                                            onClick={() => { setDevice(key); setZoom(d.scale); }}
                                            className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${device === key ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}
                                        >
                                            {d.name}
                                        </button>
                                    ))}
                                </div>
                                <button
                                    onClick={() => setIsLandscape(!isLandscape)}
                                    className={`p-2 rounded-xl border-2 transition-all ${isLandscape ? 'bg-indigo-500/20 border-indigo-500 text-indigo-400' : 'bg-slate-800 border-slate-700 text-slate-500'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
                                        <path d="M12 18h.01" />
                                        <path className={isLandscape ? 'opacity-100' : 'opacity-0'} d="M19 12l2-2-2-2m-3 2h5" />
                                    </svg>
                                </button>
                            </div>

                            <div className="flex items-center gap-4">
                                <input
                                    type="file"
                                    id="file-upload"
                                    className="hidden"
                                    accept=".html"
                                    onChange={handleFileUpload}
                                />
                                <div className="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-lg">
                                    <span className="text-[10px] font-black text-slate-500 uppercase">Zoom</span>
                                    <input
                                        type="range" min="0.3" max="1.5" step="0.1"
                                        value={zoom} onChange={(e) => setZoom(parseFloat(e.target.value))}
                                        className="w-24 accent-indigo-500"
                                    />
                                    <span className="text-[10px] font-black text-indigo-400 w-8">{Math.round(zoom * 100)}%</span>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={togglePublish}
                                        disabled={isPublishing}
                                        className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${publishedGames.has(`${(selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase())}-${selectedVersion.toLowerCase()}`) ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                                    >
                                        {isPublishing ? '...' : publishedGames.has(`${(selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase())}-${selectedVersion.toLowerCase()}`) ? 'PUBLICADO' : 'PUBLICAR'}
                                    </button>

                                    {publishedGames.has(`${(selectedGame.toLowerCase() === 'pad' ? 'pad' : selectedGame.toLowerCase())}-${selectedVersion.toLowerCase()}`) && (
                                        <button
                                            onClick={copyUrl}
                                            className="px-4 py-1.5 bg-indigo-600 text-white rounded-lg text-[10px] font-black hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20"
                                        >
                                            URL
                                        </button>
                                    )}
                                </div>
                                <div className="px-4 py-1.5 bg-indigo-500/10 rounded-lg border border-indigo-500/20">
                                    <span className="text-xs font-black text-indigo-400">{getGamePath()}</span>
                                </div>
                            </div>
                        </header>

                        {/* Device Area */}
                        <div className="flex-1 overflow-auto flex items-center justify-center p-12 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-500/5 via-transparent to-transparent">
                            <div
                                className="device-frame"
                                style={{
                                    width: isLandscape ? currentDevice.height : currentDevice.width,
                                    height: isLandscape ? currentDevice.width : currentDevice.height,
                                    transform: `scale(${zoom})`,
                                    borderWidth: '12px',
                                    padding: '0'
                                }}
                            >
                                {/* Dynamic Island / Notch Placeholder */}
                                <div className={`absolute left-50 top-1.5 left-1/2 -translate-x-1/2 bg-black rounded-full z-20 transition-all ${isLandscape ? 'w-6 h-20 -left-4 top-1/2 -translate-y-1/2' : 'w-24 h-6'}`}></div>

                                <iframe
                                    key={`${selectedGame}-${selectedVersion}-${isLandscape}`}
                                    src={getGamePath()}
                                    className="w-full h-full border-none"
                                    style={{ borderRadius: '2.2rem' }}
                                />
                            </div>
                        </div>

                        {/* Legend */}
                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-8 pointer-events-none opacity-50">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-black text-slate-500 uppercase">Resolution</span>
                                <span className="text-[10px] font-bold text-white">{isLandscape ? currentDevice.height : currentDevice.width} x {isLandscape ? currentDevice.width : currentDevice.height}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-black text-slate-500 uppercase">Platform</span>
                                <span className="text-[10px] font-bold text-white">Tiny Kids OS v4.0</span>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>